<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatermarkGenius - Home</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to your CSS file -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "iwey0nghpv");
    </script>    
<script src="./hw-hmscore-analytics-web-6.9.9-300.umd.js"></script>
<script>
    (function () {

    // https://developer.huawei.com/consumer/en/doc/development/HMSCore-Guides/javascript-accessing-0000001051147976

    const  agConnectConfig = 
{
	"agcgw":{
		"backurl":"connect-dra.hispace.hicloud.com",
		"url":"connect-dra.dbankcloud.cn",
		"websocketbackurl":"connect-ws-dra.hispace.dbankcloud.com",
		"websocketurl":"connect-ws-dra.hispace.dbankcloud.cn"
	},
	"agcgw_all":{
		"CN":"connect-drcn.dbankcloud.cn",
		"CN_back":"connect-drcn.hispace.hicloud.com",
		"DE":"connect-dre.dbankcloud.cn",
		"DE_back":"connect-dre.hispace.hicloud.com",
		"RU":"connect-drru.hispace.dbankcloud.ru",
		"RU_back":"connect-drru.hispace.dbankcloud.cn",
		"SG":"connect-dra.dbankcloud.cn",
		"SG_back":"connect-dra.hispace.hicloud.com"
	},
	"websocketgw_all":{
		"CN":"connect-ws-drcn.hispace.dbankcloud.cn",
		"CN_back":"connect-ws-drcn.hispace.dbankcloud.com",
		"DE":"connect-ws-dre.hispace.dbankcloud.cn",
		"DE_back":"connect-ws-dre.hispace.dbankcloud.com",
		"RU":"connect-ws-drru.hispace.dbankcloud.ru",
		"RU_back":"connect-ws-drru.hispace.dbankcloud.cn",
		"SG":"connect-ws-dra.hispace.dbankcloud.cn",
		"SG_back":"connect-ws-dra.hispace.dbankcloud.com"
	},
	"client":{
		"cp_id":"30086000699684214",
		"product_id":"388421841221685022",
		"client_id":"1247025396847800128",
		"client_secret":"80536CF95D00DC58A34DFD37D5AACC445A267119C0795D22187645AD665A3ED1",
		"project_id":"388421841221685022",
		"app_id":"172249065902717057",
		"api_key":"DAEDALdcZii04lsv1gOx0xNu1ZL7mnflb5c1BLB8ua2HZN0BES6BbVwOHFenbiOB7fjRVNPsMSdUkPLuG4dv6QPMF2FdVfuXyHkCuA=="
	},
	"oauth_client":{
		"client_id":"109206979",
		"client_type":7
	},
	"app_info":{
		"app_id":"172249065902717057"
	},
	"service":{
		"analytics":{
			"collector_url":"datacollector-dra.dt.hicloud.com,datacollector-dra.dt.dbankcloud.cn",
			"collector_url_ru":"datacollector-drru.dt.dbankcloud.ru,datacollector-drru.dt.hicloud.com",
			"collector_url_sg":"datacollector-dra.dt.hicloud.com,datacollector-dra.dt.dbankcloud.cn",
			"collector_url_de":"datacollector-dre.dt.hicloud.com,datacollector-dre.dt.dbankcloud.cn",
			"collector_url_cn":"datacollector-drcn.dt.hicloud.com,datacollector-drcn.dt.dbankcloud.cn",
			"resource_id":"p1",
			"channel_id":""
		},
		"edukit":{
			"edu_url":"edukit.edu.cloud.huawei.com.cn",
			"dh_url":"edukit.edu.cloud.huawei.com.cn"
		},
		"search":{
			"url":"https://search-dra.cloud.huawei.com"
		},
		"cloudstorage":{
			"storage_url_sg_back":"https://agc-storage-dra.cloud.huawei.asia",
			"storage_url_ru_back":"https://agc-storage-drru.cloud.huawei.ru",
			"storage_url_ru":"https://agc-storage-drru.cloud.huawei.ru",
			"storage_url_de_back":"https://agc-storage-dre.cloud.huawei.eu",
			"storage_url_de":"https://ops-dre.agcstorage.link",
			"storage_url":"https://agc-storage-drcn.platform.dbankcloud.cn",
			"storage_url_sg":"https://ops-dra.agcstorage.link",
			"storage_url_cn_back":"https://agc-storage-drcn.cloud.huawei.com.cn",
			"storage_url_cn":"https://agc-storage-drcn.platform.dbankcloud.cn"
		},
		"ml":{
			"mlservice_url":"ml-api-dra.ai.dbankcloud.com,ml-api-dra.ai.dbankcloud.cn"
		}
	},
	"region":"SG",
	"configuration_version":"3.0"
};
/**
 * Initializes app configuration
 */

// 启用调试模式
// agconnect.analytics.InitSettings.debugMode = true;
// 调试模式下，自定义终端标识
//agconnect.analytics.InitSettings.terminalName = "my macmini";        
//agconnect.instance().configInstance(agConnectConfig);

// 是否启用url聚类
//https://developer.huawei.com/consumer/cn/doc/development/HMSCore-Guides/javascript-accessing-0000001051147976#section2459527366
agconnect.analytics.UrlClusteringOptions.enabled= false;
// 是否移除协议
 agconnect.analytics.UrlClusteringOptions.removeProtocol= true;
// 是否移除协议、域名和端口
 agconnect.analytics.UrlClusteringOptions.removeOrigin= false;
// 是否移除全部参数
 agconnect.analytics.UrlClusteringOptions.removeAllParams= true;
// 是否移除指定参数
 agconnect.analytics.UrlClusteringOptions.removeParams= {
    // 默认处理方式，移除全部参数值，保留键名。 
     removeValuesOnly: true,
     params: {
        "key1": {
            // 是否只移除参数值，保留键名，覆盖外层的配置
            removeValuesOnly: false,
           // search|anchor|both  search表示锚点前的参数位置，anchor表示锚点后的参数位置，both表示锚点前的参数位置和锚点后的参数位置。
           position: 'both',
       }
     }
   };

// 是否移除锚点
 agconnect.analytics.UrlClusteringOptions.removeAnchor= true;
// URL模式，若传入的URL按照开关处理后满足任一模式，则上报该模式。URL模式可指定 {占位符名称} 格式的占位符，占位符匹配除urlSeparators外的所有字符。
 agconnect.analytics.UrlClusteringOptions.urlPatterns= [];
 agconnect.analytics.UrlClusteringOptions.urlSeparators= ':/.?=&#'

 agconnect.instance().configInstance(agConnectConfig);
// Initialize the Analytics Kit instance.
let analytics = agconnect.analytics();




    })()
  </script>    
</head>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script>
    // Variable to store the image folder path
    let imageFolderPath = '';
    let selectedImageFiles = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Your code here, including adding event listeners

        // Function to parse JSON files
        function parseJSONFile(fileInput, callback) {
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const jsonData = JSON.parse(event.target.result);
                callback(jsonData);
            };

            reader.readAsText(file);
        }

        // Rendering function that takes video metadata, template, and image folder path
        async function renderImages(videoMetadata, template, imageFolderPath) {


            // Iterate through each video metadata entry
            
            for (const videoInfo of videoMetadata) {
                let bgImage = videoInfo.bg_image; // Background image path from video metadata
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const image = new Image();
                let mode=0;
                if(mode==0){

                    for (const bgImage of selectedImageFiles) {

                // Load the background image

                    // If bgImage is a File object (from the selectedImageFiles array), use a FileReader
                const reader = new FileReader();
                reader.onload = function(event) {
                    image.src = event.target.result;
                };
                reader.readAsDataURL(bgImage);

                console.log('bg image',bgImage)


                // Set canvas dimensions based on template width and height
                canvas.width = template.width;
                canvas.height = template.height;

                await new Promise((resolve) => {
                    image.onload = function() {
                        // Draw the background image on the canvas
                        context.drawImage(image, 0, 0, template.width, template.height);

                        // Iterate through the template texts
                        template.texts.forEach((textInfo) => {
                            const textType = textInfo.textType;
                            const fontFile = textInfo.fontFile || template.fontFile;
                            const x = textInfo.x;
                            const y = textInfo.y;
                            const fontSize = textInfo.fontSize;
                            const fontColor = textInfo.fontcolor;

                            // Use videoInfo data based on textType (e.g., heading, subheading, extra)
                            const text = videoInfo[textType];
                            console.log('type',textType,'text',text)
                            // Set font properties
                            context.font = `${fontSize}px ${fontFile}`;
                            context.fillStyle = fontColor;

                            // Split text into multiple lines if it exceeds the maxWidth
                            const maxWidth = textInfo.width;
                            const lineHeight = textInfo.height;

                            // Draw multiline text
                            drawMultilineText(context, text, { x, y }, `${fontSize}px ${fontFile}`, maxWidth, lineHeight);
                        });

                        // Create a download link for the rendered image
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL(`${bgImage.type}`);
                        a.download = `${bgImage.name}`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        resolve();
                    };
                });





                    }






                }
                // Check if bgImage is null, None, or an empty string
                if (!bgImage || bgImage.trim() === '') {
                    // If so, randomly select an image from the image folder
                   
                    const randomIndex = Math.floor(Math.random() * selectedImageFiles.length);
                    bgImage = selectedImageFiles[randomIndex];
                    console.log('mmmmm',bgImage)
                } else {
                    bgImage = imageFolderPath + '/' + bgImage;
                }

                // Load the background image

                // Load the background image
                if (typeof bgImage === 'string') {
                    // If bgImage is a string, it's a file path
                    image.src = bgImage;
                } else {
                    // If bgImage is a File object (from the selectedImageFiles array), use a FileReader
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        image.src = event.target.result;
                    };
                    reader.readAsDataURL(bgImage);
                }

                console.log('bg image',bgImage)


                // Set canvas dimensions based on template width and height
                canvas.width = template.width;
                canvas.height = template.height;

                await new Promise((resolve) => {
                    image.onload = function() {
                        // Draw the background image on the canvas
                        context.drawImage(image, 0, 0, template.width, template.height);

                        // Iterate through the template texts
                        template.texts.forEach((textInfo) => {
                            const textType = textInfo.textType;
                            const fontFile = textInfo.fontFile || template.fontFile;
                            const x = textInfo.x;
                            const y = textInfo.y;
                            const fontSize = textInfo.fontSize;
                            const fontColor = textInfo.fontcolor;

                            // Use videoInfo data based on textType (e.g., heading, subheading, extra)
                            const text = videoInfo[textType];
                            console.log('type',textType,'text',text)
                            // Set font properties
                            context.font = `${fontSize}px ${fontFile}`;
                            context.fillStyle = fontColor;

                            // Split text into multiple lines if it exceeds the maxWidth
                            const maxWidth = textInfo.width;
                            const lineHeight = textInfo.height;

                            // Draw multiline text
                            drawMultilineText(context, text, { x, y }, `${fontSize}px ${fontFile}`, maxWidth, lineHeight);
                        });

                        // Create a download link for the rendered image
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL(`${bgImage.type}`);
                        a.download = `${bgImage.name}`;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        resolve();
                    };
                });
            }
        }

        // Function to calculate text size
        function calculateTextSize(text, font) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = font;
            const metrics = context.measureText(text);
            return {
                width: metrics.width,
                height: metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent
            };
        }

        // Function to calculate text lines
        function calculateTextLines(text, font, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const testLine = currentLine + ' ' + words[i];
                const { width } = calculateTextSize(testLine, font);
                if (width <= maxWidth) {
                    currentLine = testLine;
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }

            lines.push(currentLine);
            return lines;
        }

        // Function to draw multiline text
        function drawMultilineText(context, text, startCoord, font, maxWidth, lineHeight) {
            const lines = calculateTextLines(text, font, maxWidth);
            let x = startCoord.x;
            let y = startCoord.y;

            context.font = font;
            context.textBaseline = 'top';

            for (const line of lines) {
                context.fillText(line, x, y);
                y += lineHeight;
            }
        }

        // Function to convert canvas coordinate to corner coordinate
        function convertCanvasCoordToCorner(canvasCoord, zoneWidth, zoneHeight) {
            const zoneNumber = canvasCoord - 1;
            const zoneColumn = zoneNumber % 4;
            const zoneRow = Math.floor(zoneNumber / 4);
            const cornerX = zoneColumn - zoneWidth;
            const cornerY = zoneRow - zoneHeight;
            return { x: cornerX, y: cornerY };
        }

        // Function to get default font based on language
        function getDefaultFont(language) {
            if (language === 'en') {
                return 'Arial';
            } else if (language === 'es') {
                return 'Arial';
            } else if (language === 'zh') {
                return 'SimHei';
            }
        }

        // Attach the processData function to the Process button click event
        document.getElementById('process-button').addEventListener('click', function() {
            // Parse video metadata JSON
            parseJSONFile(document.getElementById('video-meta-input'), function(videoMetadata) {
                // Parse template JSON
                parseJSONFile(document.getElementById('template-input'), function(template) {
                    // Get image folder path
                    imageFolderPath = document.getElementById('image-folder-input').files[0].path;
                    console.log('Selected image folder path:', imageFolderPath);

                    // Call the rendering function
                    renderImages(videoMetadata, template, imageFolderPath);
                });
            });
        });


        // Listen for changes in the image file input
        document.getElementById('image-folder-input').addEventListener('change', function() {
            // Update the selected image files
            selectedImageFiles = Array.from(this.files);
            console.log('Selected image files:', selectedImageFiles);
        });


    });
</script>

<body>
    <!-- Header Section -->
    <header>
        <nav>
            <div class="logo">
                <h1>WatermarkGenius</h1>
            </div>
            <ul class="nav-links">
                <li><a href="#">Features</a></li>
                <li><a href="#">How it works</a></li>

                <li><a href="#">Pricing</a></li>
                <li><a href="#">Testimonials</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </nav>
    </header>
    <!-- Hero Section -->
    <section class="hero">
        <h1>WatermarkGenius render watermark to 100 images in one click</h1>
    </section>
<div class="container">
<section class="file-upload mt-4">
    <form id="file-upload-form" enctype="multipart/form-data">
        <!-- Input for video metadata JSON, XLSX, and CSV -->
        <div class="form-group">
            <label for="video-meta-input">Step1:Select watermark metadata file (JSON, XLSX, CSV):</label>
            <input type="file" class="form-control-file" id="video-meta-input" accept=".json,.xlsx,.csv" required>
        </div>
        <p>Demo watermark metadata file can be found <a href="https://github.com/wanghaisheng/video-publish-metadata-gpt/tree/wasm-photon" target="_blank">here</a>.</p>
        <p>JSON files can be edited using <a href="https://jsoncrack.com/editor" target="_blank">this editor</a>.</p>
    </form>
</section>

<section class="template-upload mt-4">
    <!-- Input for template JSON -->
    <form id="template-upload-form">
        <div class="form-group">
            <label for="template-input">Step2:Select watermark template JSON:</label>
            <input type="file" class="form-control-file" id="template-input" accept=".json" required>
        </div>
        <p>Demo watermark template file can be found <a href="https://github.com/wanghaisheng/video-publish-metadata-gpt/tree/wasm-photon" target="_blank">here</a>.</p>
        <p>JSON files can be edited using <a href="https://jsoncrack.com/editor" target="_blank">this editor</a>.</p>
    </form>
</section>

<section class="image-upload mt-4">
    <!-- Input for selecting a local image folder -->
    <form id="image-folder-upload-form">
        <div class="form-group">
            <label for="image-folder-input">Step3:Select source Image Folder:</label>
            <input type="file" class="form-control-file" id="image-folder-input" directory multiple>
        </div>
    </form>
</section>

<section class="button-section mt-4">
    <button type="button" id="process-button" class="btn btn-primary">Generate watermark images</button>

    <!-- Add a div to display the hint -->
    <div id="bgImageHint" class="text-danger" style="display: none;">Manually set source image feature is not yet supported. Please remove the 'bg_image' field in the video meta file.</div>

    <!-- Add a div to display the general hint -->
    <div id="generalHint" class="text-danger" style="display: none;">Please submit watermark meta and template file, source images.</div>
</section>

    <!-- Footer Section -->
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <h1>WatermarkGenius</h1>
            </div>
            <ul class="footer-nav">
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Terms of Service</a></li>
            </ul>
        </div>
    </footer>
</body>
</html>
